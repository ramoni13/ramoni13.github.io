<!DOCTYPE html>
<html>
<head>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="https://ramoni13.github.io/DJ_Festival/html5-qrcode.min.js"></script>
<script type="text/javascript" src="//cdns-files.deezer.com/js/min/dz.js"></script>
	<style>
        	body, span, select {
			font-size: 40px;
		}
		button {
		  background-color: #008CBA;
		  border: none;
		  color: white;
		  padding: 15px 32px;
		  text-align: center;
		  text-decoration: none;
		  display: inline-block;
		  font-size: 72px;
		}
	</style>
</head>
<script>
    var playlist = [];
    var playlistStart = [];
	var idTrackScan = 0;
	var idPlaylist = 0;
    var idTrackEnCours = 0;
    var firstEcoute = true;

    function init() {
		document.getElementById("reader").style.display = 'none';
		document.getElementById("playerDeezer").style.display = 'none';
		document.getElementById("menu").style.display = 'block';
		document.getElementById("playlistDiv").style.display = 'none';
	}

    function begin() {
		var html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 400 }); 
		html5QrcodeScanner.render(onScanSuccess);
	}

    function onScanSuccess(qrCodeMessage) { 
		console.log(qrCodeMessage);
			var dejaTrouve = false;
			for (j = 0; j < playlist.length; j++) {
                if (playlist[j] == qrCodeMessage) {
                    dejaTrouve = true;
                }
            }
			if (!dejaTrouve) {
				playlist.push(qrCodeMessage);
                if (playlist.length > 0) {
                    document.getElementById("playlistDiv").style.display = 'block';
                }
				document.getElementById("nbMorceaux").innerHTML = "Nb Tracks=" + playlist.length;
			}
	};

    /* 
    function readTrack() {
		document.getElementById("reader").style.display = 'none';
		document.getElementById("playerDeezer").style.display = 'block';
		var divdeez2 = document.getElementById("deezer-player");
		var srcdeez2 = divdeez2.getAttribute("src");
		srcdeez2= srcdeez2 + "&type=tracks&id=" + idTrackScan;
		divdeez2.setAttribute("src", srcdeez2);
	}
    */

    /* Randomize array in-place using Durstenfeld shuffle algorithm */
    function shuffleArray(array) {
        var info = document.getElementById('playerDeezer');
            
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
            playlistStart[i] = Math.floor(Math.random() * 100);
        }
        playlistStart[0] = Math.floor(Math.random() * 120);
        for (var i = 0; i < array.length; i++) {
            info.innerHTML = info.innerHTML + "<BR>--> " + i + " - idTrack = " + array[i] + " - Start = " + playlistStart[i];
        }
    }

    function createPlaylist() {
		playlist = [];
		document.getElementById("reader").style.display = 'block';
		document.getElementById("playerDeezer").style.display = 'none';
		document.getElementById("menu").style.display = 'none';
		begin();
	}

    function validerPlaylist() {
        if (firstEcoute) {
            shuffleArray(playlist);
            firstEcoute = false;
        }
        idPlaylist = 0;
        document.getElementById("reader").style.display = 'none';
		document.getElementById("playerDeezer").style.display = 'block';
        idTrackEnCours = playlist[0];
        var tableauD = [idTrackEnCours];
		DZ.player.playTracks(tableauD);
        DZ.player.seek(playlistStart[0]);
    }

</script>

<body width="800px" onload="javascript:init()">
	<h2>#Intro_The_Mix</h2>
    <!-- LECTEUR DEEZER -->
        <input type="button" value="Débloquer" onclick="window.open('http://cors-anywhere.herokuapp.com/corsdemo', '_blank');">
        <div id="dz-root"></div>
        <div id="player" style="width:100%;" align="center"></div>
        <br/>
        <div id="slider_seek" class="progressbarplay" style="">
        <div class="badge bg-primary" onclick="" style="font-size: xx-large;" id="timer">0:00</div>
        <div class="bar" style="width: 0%;"></div>
        </div>
    <!-- LECTURE PLAYLIST -->
        <div width="800px" id="playlistDiv" hidden="hidden">
            <div id="nbMorceaux">Nb Tracks=0</div>
            <button onclick="javascript:validerPlaylist()">Lancez l'écoute</button>
            <button onclick="javascript:init()">Menu</button>
        </div>
	
	<div width="800px" id="menu">
		<button onclick="javascript:createPlaylist()">Scannez les cartes</button>
	</div>
	
	<div width="800px" id="reader"></div>
	
	<div width="800px" id="playerDeezer" hidden="hidden"></div>
	
</body>
<script>
    function onPlayerLoaded() {
		$("#controlers input").attr('disabled', false);
		event_listener_append('player_loaded');
		DZ.Event.subscribe('current_track', function(arg){
			event_listener_append('current_track', arg.index, arg.track.title, arg.track.album.title);
            //var info = document.getElementById('playerDeezer');
            //info.innerHTML = "--> " + arg.track.title + " -- " + arg.track.artist.name;
		});
		DZ.Event.subscribe('player_position', function(arg){
			tps= arg[1];
			tpsencours = arg[0]; 
			event_listener_append('position', arg[0], arg[1]);
			$("#slider_seek").find('.bar').css('width', (100*arg[0]/arg[1]) + '%');
		});
	}
	
	DZ.init({
		appId  : '8',
		channelUrl : 'http://developers.deezer.com/examples/channel.php',
		player : {
			container : 'player',
			cover : true,
			playlist : true,
			width : 650,
			height : 100,
			onload : onPlayerLoaded
		}
	});
    $(document).ready(function(){
		$("#controlers input").attr('disabled', true);
		$("#slider_seek").click(function(evt,arg){
			var left = evt.offsetX;
			DZ.player.seek((evt.offsetX/$(this).width()) * 100);
		});
	});

	function event_listener_append() {
		var pre = document.getElementById('timer');
		var minutes = Math.floor(arguments[1] / 60);
		var seconds = arguments[1] - minutes * 60;
		seconds = Math.round(seconds * 100) / 100;
		pre.innerHTML = minutes + ":" + ("0" + Math.round(seconds)).slice(-2);
		if (arguments[1]>=parseInt(5)) {
				console.log("stop superieur ou egal à 5 (préécoute)");
				DZ.player.pause();
                if (idPlaylist < (playlist.length-1)) {
                    idPlaylist++;
                    idTrackEnCours = playlist[idPlaylist];
                    var tableauD = [idTrackEnCours];
		            DZ.player.playTracks(tableauD);
                    DZ.player.seek(playlistStart[idPlaylist]);
                } else {
                    // fin
                }
			}
    }
</script>

</html> 
